<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>dbplyrでデータサイエンス100本ノック(構造化データ加工編).</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book." />
  <meta name="generator" content="bookdown 0.27 and GitBook 2.6.7" />

  <meta property="og:title" content="dbplyrでデータサイエンス100本ノック(構造化データ加工編)." />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book." />
  <meta name="github-repo" content="Shena4746/datascience-100knocks-preprocess-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="dbplyrでデータサイエンス100本ノック(構造化データ加工編)." />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book." />
  

<meta name="author" content="Shena" />


<meta name="date" content="2022-06-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #232629;
    color: #7a7c7d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
div.sourceCode
  { color: #cfcfc2; background-color: #232629; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #cfcfc2; } /* Normal */
code span.al { color: #95da4c; } /* Alert */
code span.an { color: #3f8058; } /* Annotation */
code span.at { color: #2980b9; } /* Attribute */
code span.bn { color: #f67400; } /* BaseN */
code span.bu { color: #7f8c8d; } /* BuiltIn */
code span.cf { color: #fdbc4b; } /* ControlFlow */
code span.ch { color: #3daee9; } /* Char */
code span.cn { color: #27aeae; } /* Constant */
code span.co { color: #7a7c7d; } /* Comment */
code span.cv { color: #7f8c8d; } /* CommentVar */
code span.do { color: #a43340; } /* Documentation */
code span.dt { color: #2980b9; } /* DataType */
code span.dv { color: #f67400; } /* DecVal */
code span.er { color: #da4453; } /* Error */
code span.ex { color: #0099ff; } /* Extension */
code span.fl { color: #f67400; } /* Float */
code span.fu { color: #8e44ad; } /* Function */
code span.im { color: #27ae60; } /* Import */
code span.in { color: #c45b00; } /* Information */
code span.kw { color: #cfcfc2; } /* Keyword */
code span.op { color: #cfcfc2; } /* Operator */
code span.ot { color: #27ae60; } /* Other */
code span.pp { color: #27ae60; } /* Preprocessor */
code span.re { color: #2980b9; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #da4453; } /* SpecialString */
code span.st { color: #f44f4f; } /* String */
code span.va { color: #27aeae; } /* Variable */
code span.vs { color: #da4453; } /* VerbatimString */
code span.wa { color: #da4453; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path=""><a href="#前置き"><i class="fa fa-check"></i><b>1</b> 前置き</a><ul>
<li class="chapter" data-level="1.1" data-path=""><a href="#概要"><i class="fa fa-check"></i><b>1.1</b> 概要</a></li>
<li class="chapter" data-level="1.2" data-path=""><a href="#dbplyr-とは"><i class="fa fa-check"></i><b>1.2</b> dbplyr とは</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path=""><a href="#準備"><i class="fa fa-check"></i><b>2</b> 準備</a></li>
<li class="chapter" data-level="3" data-path=""><a href="#回答例"><i class="fa fa-check"></i><b>3</b> 回答例</a><ul>
<li class="chapter" data-level="" data-path=""><a href="#r-006"><i class="fa fa-check"></i>R-006</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-015"><i class="fa fa-check"></i>R-015</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-016"><i class="fa fa-check"></i>R-016</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-019"><i class="fa fa-check"></i>R-019</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-020"><i class="fa fa-check"></i>R-020</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-026"><i class="fa fa-check"></i>R-026</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-028"><i class="fa fa-check"></i>R-028</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-029"><i class="fa fa-check"></i>R-029</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-031"><i class="fa fa-check"></i>R-031</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-033"><i class="fa fa-check"></i>R-033</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-036"><i class="fa fa-check"></i>R-036</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-038"><i class="fa fa-check"></i>R-038</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-039"><i class="fa fa-check"></i>R-039</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-041"><i class="fa fa-check"></i>R-041</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-042"><i class="fa fa-check"></i>R-042</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-043"><i class="fa fa-check"></i>R-043</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-044"><i class="fa fa-check"></i>R-044</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-045"><i class="fa fa-check"></i>R-045</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-046"><i class="fa fa-check"></i>R-046</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-047"><i class="fa fa-check"></i>R-047</a></li>
<li class="chapter" data-level="3.1" data-path=""><a href="#日付処理へのコメント"><i class="fa fa-check"></i><b>3.1</b> 日付処理へのコメント</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-052"><i class="fa fa-check"></i>R-052</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-053"><i class="fa fa-check"></i>R-053</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-054"><i class="fa fa-check"></i>R-054</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-055"><i class="fa fa-check"></i>R-055</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-056"><i class="fa fa-check"></i>R-056</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-057"><i class="fa fa-check"></i>R-057</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-058"><i class="fa fa-check"></i>R-058</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-059"><i class="fa fa-check"></i>R-059</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-060"><i class="fa fa-check"></i>R-060</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-069"><i class="fa fa-check"></i>R-069</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-070"><i class="fa fa-check"></i>R-070</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-074"><i class="fa fa-check"></i>R-074</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-078"><i class="fa fa-check"></i>R-078</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-079"><i class="fa fa-check"></i>R-079</a></li>
<li class="chapter" data-level="" data-path=""><a href="#r-080"><i class="fa fa-check"></i>R-080</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dbplyrでデータサイエンス100本ノック(構造化データ加工編).</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">dbplyrでデータサイエンス100本ノック(構造化データ加工編).</h1>
<p class="author"><em>Shena</em></p>
<p class="date"><em>2022-06-27</em></p>
</div>
<div id="前置き" class="section level1 hasAnchor">
<h1><span class="header-section-number">1</span> 前置き<a href="#前置き" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="概要" class="section level2 hasAnchor">
<h2><span class="header-section-number">1.1</span> 概要<a href="#概要" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>このドキュメントは, <a href="https://github.com/The-Japan-DataScientist-Society/100knocks-preprocess">データサイエンス100本ノック（構造化データ加工編）</a> を R で解いた記録. dbplyr パッケージを利用して, 手元にデータをダウンロードせず, できるだけローカルの計算資源に依存しない方針をとる.</p>
<div class="note">
<p>全問の回答は載せていない. 特に, SQL の方が楽にできる問題はスキップしている.</p>
</div>
</div>
<div id="dbplyr-とは" class="section level2 hasAnchor">
<h2><span class="header-section-number">1.2</span> dbplyr とは<a href="#dbplyr-とは" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>詳細は以下に貼る公式ドキュメントや解説記事に譲り, ここでは大雑把に書く. dbplyr とは, dplyr の文法で書いた加工処理を SQL クエリに翻訳して実行し, その結果を返してくれるパッケージ.</p>
<ul>
<li><a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a></li>
<li><a href="https://yutatoyama.github.io/note/intro_R_for_SQL.html">巨大なデータがSQLサーバーにあるときに、Rでどう立ち向かうかマニュアル：dbplyrパッケージを中心として</a></li>
</ul>
<p>手元にデータをダウンロードしようとしなければ, SQL の場合と同様に, クエリの実行コストはサーバー側が持ってくれる. dbplyr で SQL に翻訳可能なコードのみ利用可能. したがって, 手元にデータを直接ダウンロードした場合に比べて, 必然的に道具立ては少なくなる. なお, この翻訳可能性は個別のコード単位で決定されるものであり, パッケージ単位で決まっているわけではない. この翻訳問題を回避するには, <code>collect()</code> を使ってクエリ実行後の実データをダウンロードする必要があるが, それが一般に可能なのは <code>summarise()</code> などでデータサイズが十分に小さくなった場合であろう.</p>

</div>
</div>
<div id="準備" class="section level1 hasAnchor">
<h1><span class="header-section-number">2</span> 準備<a href="#準備" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Postgres DB が立ててあると想定して, R から DB へ接続する.
<a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a> 記載の方法に従う.</p>
<p>必須パッケージ達.
最初の2つは DB への接続用.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(<span class="st">&quot;DBI&quot;</span>)</a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(<span class="st">&quot;RPostgreSQL&quot;</span>)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">library</span>(<span class="st">&quot;dbplyr&quot;</span>)</a>
<a class="sourceLine" id="cb1-4" title="4"><span class="kw">library</span>(<span class="st">&quot;dplyr&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">R.version.string <span class="co"># R version</span></a>
<a class="sourceLine" id="cb2-2" title="2"><span class="co">## [1] &quot;R version 4.2.0 (2022-04-22)&quot;</span></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">packageVersion</span>(<span class="st">&quot;DBI&quot;</span>)</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="co">## [1] &#39;1.1.2&#39;</span></a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw">packageVersion</span>(<span class="st">&quot;RPostgreSQL&quot;</span>)</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="co">## [1] &#39;0.7.3&#39;</span></a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw">packageVersion</span>(<span class="st">&quot;dbplyr&quot;</span>)</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="co">## [1] &#39;2.1.1&#39;</span></a>
<a class="sourceLine" id="cb2-9" title="9"><span class="kw">packageVersion</span>(<span class="st">&quot;dplyr&quot;</span>)</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="co">## [1] &#39;1.0.9&#39;</span></a></code></pre></div>
<p>まだしてなければ, Postgres を起動.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1"><span class="fu">sudo</span> service postgresql start</a></code></pre></div>
<p><a href="https://dbplyr.tidyverse.org/articles/dbplyr.html">Introduction to dbplyr</a> は, DB 接続のためのコードとして以下の例と注意を述べている:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb4-2" title="2">    RPostgreSQL<span class="op">::</span><span class="kw">PostgreSQL</span>(),</a>
<a class="sourceLine" id="cb4-3" title="3">    <span class="dt">host =</span> <span class="st">&quot;database.rstudio.com&quot;</span>,</a>
<a class="sourceLine" id="cb4-4" title="4">    <span class="dt">user =</span> <span class="st">&quot;your-name&quot;</span>,</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="dt">password =</span> rstudioapi<span class="op">::</span><span class="kw">askForPassword</span>(<span class="st">&quot;Database password&quot;</span>)</a>
<a class="sourceLine" id="cb4-6" title="6">)</a></code></pre></div>
<blockquote>
<p>If you’re not using RStudio, you’ll need some other way to securely retrieve your password. You should never record it in your analysis scripts or type it into the console. <a href="https://db.rstudio.com/best-practices/managing-credentials">Securing Credentials</a> provides some best practices.</p>
</blockquote>
<p>これを踏まえると, 以下の接続方法は大変行儀が悪いが, どうせ localhost にこのノック限定で立てているDBだろうし, さっさと準備を終える意味でも, ここでは咎めないことにする.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">con &lt;-<span class="st"> </span>DBI<span class="op">::</span><span class="kw">dbConnect</span>(</a>
<a class="sourceLine" id="cb5-2" title="2">    RPostgreSQL<span class="op">::</span><span class="kw">PostgreSQL</span>(),</a>
<a class="sourceLine" id="cb5-3" title="3">    <span class="dt">host =</span> <span class="st">&quot;localhost&quot;</span>,</a>
<a class="sourceLine" id="cb5-4" title="4">    <span class="dt">port =</span> <span class="dv">5432</span>,</a>
<a class="sourceLine" id="cb5-5" title="5">    <span class="dt">dbname =</span> <span class="st">&quot;your-database-name&quot;</span>,</a>
<a class="sourceLine" id="cb5-6" title="6">    <span class="dt">user =</span> <span class="st">&quot;your-user&quot;</span>,</a>
<a class="sourceLine" id="cb5-7" title="7">    <span class="dt">password =</span> <span class="st">&quot;your-password&quot;</span></a>
<a class="sourceLine" id="cb5-8" title="8">)</a></code></pre></div>
<p>接続できたか確認.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">DBI<span class="op">::</span><span class="kw">dbListTables</span>(con)</a></code></pre></div>
<pre><code>## [1] &quot;customer&quot; &quot;category&quot; &quot;geocode&quot;  &quot;product&quot;  &quot;receipt&quot;  &quot;store&quot;</code></pre>
<p>各テーブルへの参照を取得.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">customer_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;customer&quot;</span>)</a>
<a class="sourceLine" id="cb8-2" title="2">category_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;category&quot;</span>)</a>
<a class="sourceLine" id="cb8-3" title="3">product_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;product&quot;</span>)</a>
<a class="sourceLine" id="cb8-4" title="4">receipt_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;receipt&quot;</span>)</a>
<a class="sourceLine" id="cb8-5" title="5">store_tbl &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">tbl</span>(con, <span class="st">&quot;store&quot;</span>)</a></code></pre></div>
<p>ちゃんとクエリが飛ばせるかテスト.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1000</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" title="3"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 9]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   sales_ymd sales_epoch store_cd receipt_no receipt_sub_no customer_id   
##       &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;int&gt;          &lt;int&gt; &lt;chr&gt;         
## 1  20181225  1545696000 S13020         1172              2 ZZ000000000000
## 2  20180911  1536624000 S13018         1122              2 CS018205000001
## 3  20170501  1493596800 S13004         1192              2 CS004415000232
## 4  20170523  1495497600 S14028         1182              2 CS028415000203
## 5  20180310  1520640000 S14028          112              1 ZZ000000000000
## 6  20170516  1494892800 S14023         1102              1 CS023415000240
## # … with 3 more variables: product_cd &lt;chr&gt;, quantity &lt;int&gt;, amount &lt;int&gt;</code></pre>
<p>この <code>customer_tbl</code> 等の参照を使って dplyr の文法でデータ加工処理を書いていく.</p>

</div>
<div id="回答例" class="section level1 hasAnchor">
<h1><span class="header-section-number">3</span> 回答例<a href="#回答例" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>以下, ノックの設問とその回答を並べていく.
設問文は, 100本ノック本家から引用.</p>
<div id="r-006" class="section level2 unnumbered hasAnchor">
<h2>R-006<a href="#r-006" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）から売上⽇（sales_ymd）、顧客（customer_id）、商品コード（product_cd）、売上数量（quantity）、売上⾦額（amount）の順に列を指定し、以下の全ての条件を満たすデータを抽出せよ。</p>
</blockquote>
<ul>
<li>顧客ID（customer_id）が“CS018205000001”</li>
<li>売上⾦額（amount）が1,000以上または売上数量（quantity）が5以上</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="st">    </span><span class="kw">filter</span>(amount <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1000</span> <span class="op">||</span><span class="st"> </span>quantity <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="st">    </span><span class="kw">filter</span>(customer_id <span class="op">==</span><span class="st"> &quot;CS018205000001&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-4" title="4"><span class="st">    </span><span class="kw">select</span>(sales_ymd, customer_id, product_cd, quantity, amount) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 5]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   sales_ymd customer_id    product_cd quantity amount
##       &lt;int&gt; &lt;chr&gt;          &lt;chr&gt;         &lt;int&gt;  &lt;int&gt;
## 1  20180911 CS018205000001 P071401012        1   2200
## 2  20180414 CS018205000001 P060104007        6    600
## 3  20170614 CS018205000001 P050206001        5    990
## 4  20190226 CS018205000001 P071401020        1   2200
## 5  20180911 CS018205000001 P071401005        1   1100</code></pre>
</div>
<div id="r-015" class="section level2 unnumbered hasAnchor">
<h2>R-015<a href="#r-015" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）から、ステータスコード（status_cd）の先頭がアルファベットのA〜Fで始まり、末尾が数字の1〜9で終わるデータを全項⽬抽出し、10件表⽰せよ。</p>
</blockquote>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb13-2" title="2"><span class="co"># use stringr::str_detect()</span></a>
<a class="sourceLine" id="cb13-3" title="3">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-4" title="4"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(status_cd, <span class="st">&quot;^[A-F].*[1-9]$&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 11]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id  customer_name gender_cd gender birth_day    age postal_cd address
##   &lt;chr&gt;        &lt;chr&gt;             &lt;int&gt; &lt;chr&gt;  &lt;date&gt;     &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  
## 1 CS011215000… 芦田 沙耶             1 女性   1992-02-01    27 223-0062  神奈川…
## 2 CS022513000… 島村 貴美子           1 女性   1962-03-12    57 249-0002  神奈川…
## 3 CS001515000… 水野 陽子             9 不明   1960-11-29    58 144-0053  東京都…
## 4 CS013615000… 西脇 季衣             1 女性   1953-10-18    65 261-0026  千葉県…
## 5 CS020412000… 小宮 薫               1 女性   1974-05-21    44 174-0042  東京都…
## 6 CS001215000… 竹中 あさみ           1 女性   1990-07-25    28 146-0095  東京都…
## # … with 3 more variables: application_store_cd &lt;chr&gt;, application_date &lt;chr&gt;,
## #   status_cd &lt;chr&gt;</code></pre>
</div>
<div id="r-016" class="section level2 unnumbered hasAnchor">
<h2>R-016<a href="#r-016" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>店舗データ（df_store）から、電話番号（tel_no）が3桁-3桁-4桁のデータを全項目表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">store_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(tel_no, <span class="st">&quot;^</span><span class="ch">\\</span><span class="st">d{3}-</span><span class="ch">\\</span><span class="st">d{3}-</span><span class="ch">\\</span><span class="st">d{4}$&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 10]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   store_cd store_name   prefecture_cd prefecture address     address_kana tel_no
##   &lt;chr&gt;    &lt;chr&gt;                &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;        &lt;chr&gt; 
## 1 S12014   千草台店                12 千葉県     千葉県千葉… チバケンチ…  043-1…
## 2 S13002   国分寺店                13 東京都     東京都国分… トウキョウ…  042-1…
## 3 S14010   菊名店                  14 神奈川県   神奈川県横… カナガワケ…  045-1…
## 4 S14033   阿久和店                14 神奈川県   神奈川県横… カナガワケ…  045-1…
## 5 S14036   相模原中央店            14 神奈川県   神奈川県相… カナガワケ…  042-1…
## 6 S14040   長津田店                14 神奈川県   神奈川県横… カナガワケ…  045-1…
## # … with 3 more variables: longitude &lt;dbl&gt;, latitude &lt;dbl&gt;, floor_area &lt;dbl&gt;</code></pre>
</div>
<div id="r-019" class="section level2 unnumbered hasAnchor">
<h2>R-019<a href="#r-019" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、1件あたりの売上金額（amount）が高い順にランクを付与し、先頭から10件表示せよ。項目は顧客ID（customer_id）、売上金額（amount）、付与したランクを表示させること。なお、売上金額（amount）が等しい場合は同一順位を付与するものとする。</p>
</blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="st">    </span><span class="kw">select</span>(customer_id, amount) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">ranking =</span> <span class="kw">min_rank</span>(<span class="kw">desc</span>(amount))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">    </span><span class="kw">arrange</span>(ranking) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:     lazy query [?? x 3]
## # Database:   postgres 12.0.11 [@localhost:5432/knock100]
## # Ordered by: ranking
##   customer_id    amount ranking
##   &lt;chr&gt;           &lt;int&gt;   &lt;dbl&gt;
## 1 CS011415000006  10925       1
## 2 ZZ000000000000   6800       2
## 3 CS028605000002   5780       3
## 4 ZZ000000000000   5480       4
## 5 CS015515000034   5480       4
## 6 ZZ000000000000   5480       4</code></pre>
</div>
<div id="r-020" class="section level2 unnumbered hasAnchor">
<h2>R-020<a href="#r-020" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、1件あたりの売上金額（amount）が高い順にランクを付与し、先頭から10件表示せよ。項目は顧客ID（customer_id）、売上金額（amount）、付与したランクを表示させること。なお、売上金額（amount）が等しい場合でも別順位を付与すること。</p>
</blockquote>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="st">    </span><span class="kw">select</span>(customer_id, amount) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">ranking =</span> <span class="kw">row_number</span>(<span class="kw">desc</span>(amount))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="st">    </span><span class="kw">arrange</span>(ranking) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:     lazy query [?? x 3]
## # Database:   postgres 12.0.11 [@localhost:5432/knock100]
## # Ordered by: ranking
##   customer_id    amount ranking
##   &lt;chr&gt;           &lt;int&gt;   &lt;dbl&gt;
## 1 CS011415000006  10925       1
## 2 ZZ000000000000   6800       2
## 3 CS028605000002   5780       3
## 4 ZZ000000000000   5480       4
## 5 CS015515000034   5480       5
## 6 ZZ000000000000   5480       6</code></pre>

</div>
<div id="r-026" class="section level2 unnumbered hasAnchor">
<h2>R-026<a href="#r-026" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、顧客ID（customer_id）ごとに最も新しい売上年⽉⽇（sales_ymd）と古い売上年⽉⽇を求め、両者が異なるデータを10件表⽰せよ。</p>
</blockquote>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">latest_ymd =</span> <span class="kw">max</span>(sales_ymd, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dt">oldest_ymd =</span> <span class="kw">min</span>(sales_ymd, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">    </span><span class="kw">filter</span>(latest_ymd <span class="op">!=</span><span class="st"> </span>oldest_ymd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    latest_ymd oldest_ymd
##   &lt;chr&gt;               &lt;int&gt;      &lt;int&gt;
## 1 CS029212000033   20180621   20170318
## 2 CS007515000119   20190511   20170201
## 3 CS034515000123   20190708   20170527
## 4 CS026414000014   20190720   20170718
## 5 CS010515000082   20181204   20180518
## 6 CS019315000045   20170920   20170423</code></pre>
</div>
<div id="r-028" class="section level2 unnumbered hasAnchor">
<h2>R-028<a href="#r-028" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、店舗コード（store_cd）ごとに売上額
（amount）の中央値を計算し、降順でTOP5を表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(store_cd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">median</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-4" title="4"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:     lazy query [?? x 2]
## # Database:   postgres 12.0.11 [@localhost:5432/knock100]
## # Ordered by: desc(amount)
##   store_cd amount
##   &lt;chr&gt;     &lt;dbl&gt;
## 1 S13052      190
## 2 S14010      188
## 3 S14050      185
## 4 S14040      180
## 5 S13003      180
## 6 S13018      180</code></pre>
</div>
<div id="r-029" class="section level2 unnumbered hasAnchor">
<h2>R-029<a href="#r-029" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、店舗コード（store_cd）ごとに商品コード（product_cd）の最頻値を求め、10件表示させよ。</p>
</blockquote>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(store_cd, product_cd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">count =</span> <span class="kw">n</span>(), <span class="dt">.groups =</span> <span class="st">&quot;drop_last&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-4" title="4"><span class="st">    </span><span class="kw">filter</span>(count <span class="op">==</span><span class="st"> </span><span class="kw">max</span>(count, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
## # Groups:   store_cd
##   store_cd product_cd count
##   &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt;
## 1 S12007   P060303001    72
## 2 S12013   P060303001   107
## 3 S12014   P060303001    65
## 4 S12029   P060303001    92
## 5 S12030   P060303001   115
## 6 S13001   P060303001    67</code></pre>
</div>
<div id="r-031" class="section level2 unnumbered hasAnchor">
<h2>R-031<a href="#r-031" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、店舗コード（store_cd）ごとに売上金額（amount）の標準偏差を計算し、降順で5件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(store_cd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">sd =</span> <span class="kw">sd</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-4" title="4"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(sd)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb27-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:     lazy query [?? x 2]
## # Database:   postgres 12.0.11 [@localhost:5432/knock100]
## # Ordered by: desc(sd)
##   store_cd    sd
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 S13052    665.
## 2 S14011    554.
## 3 S14034    545.
## 4 S13001    544.
## 5 S13015    544.
## 6 S13035    527.</code></pre>
</div>
<div id="r-033" class="section level2 unnumbered hasAnchor">
<h2>R-033<a href="#r-033" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）に対し、店舗コード（store_cd）ごとに売上金額（amount）の平均を計算し、330以上のものを抽出せよ。</p>
</blockquote>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(store_cd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">total =</span> <span class="kw">mean</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="st">    </span><span class="kw">filter</span>(total <span class="op">&gt;=</span><span class="st"> </span><span class="dv">330</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-5" title="5"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   store_cd total
##   &lt;chr&gt;    &lt;dbl&gt;
## 1 S13052    403.
## 2 S13019    330.
## 3 S13003    351.
## 4 S14045    330.
## 5 S13004    331.
## 6 S13001    348.</code></pre>
</div>
<div id="r-036" class="section level2 unnumbered hasAnchor">
<h2>R-036<a href="#r-036" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）と店舗データ（df_store）を内部結合し、レシート明細データの全項目と店舗データの店舗名（store_name）を10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1"><span class="kw">inner_join</span>(receipt_tbl, store_tbl, <span class="dt">by =</span> <span class="st">&quot;store_cd&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 18]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   sales_ymd sales_epoch store_cd receipt_no receipt_sub_no customer_id   
##       &lt;int&gt;       &lt;int&gt; &lt;chr&gt;         &lt;int&gt;          &lt;int&gt; &lt;chr&gt;         
## 1  20181103  1541203200 S14006          112              1 CS006214000001
## 2  20181118  1542499200 S13008         1132              2 CS008415000097
## 3  20170712  1499817600 S14028         1102              1 CS028414000014
## 4  20190205  1549324800 S14042         1132              1 ZZ000000000000
## 5  20180821  1534809600 S14025         1102              2 CS025415000050
## 6  20190605  1559692800 S13003         1112              1 CS003515000195
## # … with 12 more variables: product_cd &lt;chr&gt;, quantity &lt;int&gt;, amount &lt;int&gt;,
## #   store_name &lt;chr&gt;, prefecture_cd &lt;int&gt;, prefecture &lt;chr&gt;, address &lt;chr&gt;,
## #   address_kana &lt;chr&gt;, tel_no &lt;chr&gt;, longitude &lt;dbl&gt;, latitude &lt;dbl&gt;,
## #   floor_area &lt;dbl&gt;</code></pre>
</div>
<div id="r-038" class="section level2 unnumbered hasAnchor">
<h2>R-038<a href="#r-038" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）とレシート明細データ（df_receipt）から、顧客ごとの売上金額合計を求め、10件表示せよ。ただし、売上実績がない顧客については売上金額を0として表示させること。また、顧客は性別コード（gender_cd）が女性（1）であるものを対象とし、非会員（顧客IDが“Z”から始まるもの）は除外すること。</p>
</blockquote>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" title="1">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-2" title="2"><span class="st">    </span><span class="kw">filter</span>(gender_cd <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-3" title="3"><span class="st">    </span><span class="kw">left_join</span>(receipt_tbl, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-4" title="4"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-5" title="5"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">coalesce</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-6" title="6"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb33-7" title="7"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:     lazy query [?? x 2]
## # Database:   postgres 12.0.11 [@localhost:5432/knock100]
## # Ordered by: desc(amount)
##   customer_id    amount
##   &lt;chr&gt;           &lt;dbl&gt;
## 1 CS017415000097  23086
## 2 CS015415000185  20153
## 3 CS031414000051  19202
## 4 CS028415000007  19127
## 5 CS010214000010  18585
## 6 CS006515000023  18372</code></pre>
</div>
<div id="r-039" class="section level2 unnumbered hasAnchor">
<h2>R-039<a href="#r-039" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）から、売上日数の多い顧客の上位20件を抽出したデータと、売上金額合計の多い顧客の上位20件を抽出したデータをそれぞれ作成し、さらにその2つを完全外部結合せよ。ただし、非会員（顧客IDが“Z”から始まるもの）は除外すること。</p>
</blockquote>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" title="1">reciept_by_id &lt;-<span class="st"> </span>receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-3" title="3"><span class="st">    </span><span class="kw">group_by</span>(customer_id)</a>
<a class="sourceLine" id="cb35-4" title="4"></a>
<a class="sourceLine" id="cb35-5" title="5">days_top &lt;-<span class="st"> </span>reciept_by_id <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-6" title="6"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">n_days =</span> <span class="kw">n_distinct</span>(sales_ymd) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">coalesce</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-7" title="7"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n_days)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-8" title="8"><span class="st">    </span><span class="kw">head</span>(<span class="dv">20</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-9" title="9"><span class="st">    </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb35-10" title="10"></a>
<a class="sourceLine" id="cb35-11" title="11">amount_top &lt;-<span class="st"> </span>reciept_by_id <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-12" title="12"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw">coalesce</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-13" title="13"><span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-14" title="14"><span class="st">    </span><span class="kw">head</span>(<span class="dv">20</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-15" title="15"><span class="st">    </span><span class="kw">collect</span>()</a>
<a class="sourceLine" id="cb35-16" title="16"></a>
<a class="sourceLine" id="cb35-17" title="17">days_top <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-18" title="18"><span class="st">    </span><span class="kw">full_join</span>(amount_top, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb35-19" title="19"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   customer_id    n_days amount
##   &lt;chr&gt;           &lt;dbl&gt;  &lt;dbl&gt;
## 1 CS040214000008     23     NA
## 2 CS015415000185     22  20153
## 3 CS010214000010     22  18585
## 4 CS028415000007     21  19127
## 5 CS010214000002     21     NA
## 6 CS017415000097     20  23086</code></pre>

</div>
<div id="r-041" class="section level2 unnumbered hasAnchor">
<h2>R-041<a href="#r-041" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上金額（amount）を日付（sales_ymd）ごとに集計し、前回売上があった日からの売上金額増減を計算せよ。そして結果を10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(sales_ymd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">sales_today =</span> <span class="kw">sum</span>(amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-4" title="4"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">sales_yest =</span> sales_today <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">lag</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-5" title="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">diff =</span> sales_today <span class="op">-</span><span class="st"> </span>sales_yest) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb37-6" title="6"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 4]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   sales_ymd sales_today sales_yest   diff
##       &lt;int&gt;       &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;
## 1  20190504       49561         NA     NA
## 2  20180414       27599      49561 -21962
## 3  20170416       16442      27599 -11157
## 4  20190422       37044      16442  20602
## 5  20190710       27796      37044  -9248
## 6  20181027       28497      27796    701</code></pre>
</div>
<div id="r-042" class="section level2 unnumbered hasAnchor">
<h2>R-042<a href="#r-042" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上金額（amount）を日付（sales_ymd）ごとに集計し、各日付のデータに対し、前回、前々回、3回前に売上があった日のデータを結合せよ。そして結果を10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-2" title="2"><span class="st">    </span><span class="kw">group_by</span>(sales_ymd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-3" title="3"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">sales_daily =</span> <span class="kw">sum</span>(sales_ymd)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-4" title="4"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb39-5" title="5">        <span class="kw">across</span>(</a>
<a class="sourceLine" id="cb39-6" title="6">            <span class="dt">.cols =</span> sales_daily,</a>
<a class="sourceLine" id="cb39-7" title="7">            <span class="dt">.fns =</span> <span class="kw">list</span>(</a>
<a class="sourceLine" id="cb39-8" title="8">                <span class="dt">lag_1 =</span> <span class="op">~</span><span class="st"> </span><span class="kw">lag</span>(.x, <span class="dt">n =</span> <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb39-9" title="9">                <span class="dt">lag_2 =</span> <span class="op">~</span><span class="st"> </span><span class="kw">lag</span>(.x, <span class="dt">n =</span> <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb39-10" title="10">                <span class="dt">lag_3 =</span> <span class="op">~</span><span class="st"> </span><span class="kw">lag</span>(.x, <span class="dt">n =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb39-11" title="11">            )</a>
<a class="sourceLine" id="cb39-12" title="12">        )</a>
<a class="sourceLine" id="cb39-13" title="13">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb39-14" title="14"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 5]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   sales_ymd sales_daily sales_daily_lag_1 sales_daily_lag_2 sales_daily_lag_3
##       &lt;int&gt;       &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1  20190504  2382479472                NA                NA                NA
## 2  20180414  2118943470        2382479472                NA                NA
## 3  20170416  1593462864        2118943470        2382479472                NA
## 4  20190422  2261327264        1593462864        2118943470        2382479472
## 5  20190710  2059452420        2261327264        1593462864        2118943470
## 6  20181027  1836473457        2059452420        2261327264        1593462864</code></pre>
<p><code>collect()</code> していいなら次のように書ける.
<code>.fns</code> に与える formula のリスト (関数のリストでも可) を <code>fms</code> として事前に作っておく.
文字列を変換して formula を作ってしているのは, 変数 <code>d</code> の遅延評価を避けるため.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb41-2" title="2"></a>
<a class="sourceLine" id="cb41-3" title="3">D &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb41-4" title="4"></a>
<a class="sourceLine" id="cb41-5" title="5"><span class="co"># lag formulas to apply</span></a>
<a class="sourceLine" id="cb41-6" title="6">fms &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb41-7" title="7"><span class="cf">for</span> (d <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>D) fms[[d]] &lt;-<span class="st"> </span>stringr<span class="op">::</span><span class="kw">str_c</span>(<span class="st">&quot;~ lag(.x, n = &quot;</span>, d, <span class="st">&quot;)&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.formula</span>()</a>
<a class="sourceLine" id="cb41-8" title="8"></a>
<a class="sourceLine" id="cb41-9" title="9">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-10" title="10"><span class="st">    </span><span class="kw">group_by</span>(sales_ymd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-11" title="11"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">sales_daily =</span> <span class="kw">sum</span>(sales_ymd)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-12" title="12"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-13" title="13"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb41-14" title="14">        <span class="kw">across</span>(</a>
<a class="sourceLine" id="cb41-15" title="15">            <span class="dt">.cols =</span> sales_daily,</a>
<a class="sourceLine" id="cb41-16" title="16">            <span class="dt">.fns =</span> fms,</a>
<a class="sourceLine" id="cb41-17" title="17">            <span class="dt">.names =</span> <span class="st">&quot;{.col}_lag_{.fn}&quot;</span></a>
<a class="sourceLine" id="cb41-18" title="18">        )</a>
<a class="sourceLine" id="cb41-19" title="19">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb41-20" title="20"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 5
##   sales_ymd sales_daily sales_daily_lag_1 sales_daily_lag_2 sales_daily_lag_3
##       &lt;int&gt;       &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1  20190504  2382479472                NA                NA                NA
## 2  20180414  2118943470        2382479472                NA                NA
## 3  20170416  1593462864        2118943470        2382479472                NA
## 4  20190422  2261327264        1593462864        2118943470        2382479472
## 5  20190710  2059452420        2261327264        1593462864        2118943470
## 6  20181027  1836473457        2059452420        2261327264        1593462864</code></pre>
</div>
<div id="r-043" class="section level2 unnumbered hasAnchor">
<h2>R-043<a href="#r-043" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）と顧客データ（df_customer）を結合し、性別コード（gender_cd）と年代（ageから計算）ごとに売上金額（amount）を合計した売上サマリデータを作成せよ。性別コードは0が男性、1が女性、9が不明を表すものとする。</p>
</blockquote>
<p>ただし、項目構成は年代、女性の売上金額、男性の売上金額、性別不明の売上金額の4項目とすること（縦に年代、横に性別のクロス集計）。また、年代は10歳ごとの階級とすること。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-2" title="2"><span class="st">    </span><span class="kw">inner_join</span>(customer_tbl, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">generation =</span> age <span class="op">-</span><span class="st"> </span>age <span class="op">%%</span><span class="st"> </span><span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-4" title="4"><span class="st">    </span><span class="kw">group_by</span>(generation, gender_cd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-5" title="5"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">sales_amount =</span> amount <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>(), <span class="dt">.groups =</span> <span class="st">&quot;drop&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-6" title="6"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw">pivot_wider</span>(</a>
<a class="sourceLine" id="cb43-7" title="7">        <span class="dt">names_from =</span> gender_cd,</a>
<a class="sourceLine" id="cb43-8" title="8">        <span class="dt">names_prefix =</span> <span class="st">&quot;sales&quot;</span>,</a>
<a class="sourceLine" id="cb43-9" title="9">        <span class="dt">values_from =</span> sales_amount,</a>
<a class="sourceLine" id="cb43-10" title="10">        <span class="dt">values_fill =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb43-11" title="11">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-12" title="12"><span class="st">    </span><span class="kw">rename</span>(</a>
<a class="sourceLine" id="cb43-13" title="13">        <span class="dt">sales_male =</span> sales0,</a>
<a class="sourceLine" id="cb43-14" title="14">        <span class="dt">sales_female =</span> sales1,</a>
<a class="sourceLine" id="cb43-15" title="15">        <span class="dt">sales_other =</span> sales9</a>
<a class="sourceLine" id="cb43-16" title="16">    ) -&gt;<span class="st"> </span>sales_summary</a>
<a class="sourceLine" id="cb43-17" title="17">sales_summary</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 4]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   generation sales_male sales_female sales_other
##        &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1         10       1591       149836        4317
## 2         20      72940      1363724       44328
## 3         30     177322       693047       50441
## 4         40      19355      9320791      483512
## 5         50      54320      6685192      342923
## 6         60     272469       987741       71418
## 7         70      13435        29764        2427
## 8         80      46360       262923        5111
## 9         90          0         6260           0</code></pre>
</div>
<div id="r-044" class="section level2 unnumbered hasAnchor">
<h2>R-044<a href="#r-044" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>043で作成した売上サマリデータ（df_sales_summary）は性別の売上を横持ちさせたものであった。このデータから性別を縦持ちさせ、年代、性別コード、売上金額の3項目に変換せよ。ただし、性別コードは男性を“00”、女性を“01”、不明を“99”とする</p>
</blockquote>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1">sales_summary <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-2" title="2"><span class="st">    </span><span class="kw">rename</span>(<span class="st">&quot;00&quot;</span> =<span class="st"> </span>sales_male, <span class="st">&quot;01&quot;</span> =<span class="st"> </span>sales_female, <span class="st">&quot;99&quot;</span> =<span class="st"> </span>sales_other) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-3" title="3"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(</a>
<a class="sourceLine" id="cb45-4" title="4">        <span class="dt">cols =</span> <span class="op">-</span>generation,</a>
<a class="sourceLine" id="cb45-5" title="5">        <span class="dt">names_to =</span> <span class="st">&quot;gender_cd&quot;</span>,</a>
<a class="sourceLine" id="cb45-6" title="6">        <span class="dt">values_to =</span> <span class="st">&quot;sales_amount&quot;</span></a>
<a class="sourceLine" id="cb45-7" title="7">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-8" title="8"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   generation gender_cd sales_amount
##        &lt;dbl&gt; &lt;chr&gt;            &lt;dbl&gt;
## 1         10 00                1591
## 2         20 00               72940
## 3         30 00              177322
## 4         40 00               19355
## 5         50 00               54320
## 6         60 00              272469</code></pre>
</div>
<div id="r-045" class="section level2 unnumbered hasAnchor">
<h2>R-045<a href="#r-045" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）の生年月日（birth_day）は日付型でデータを保有している。これをYYYYMMDD形式の文字列に変換し、顧客ID（customer_id）とともに10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb47-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb47-2" title="2"><span class="co"># use stringr::str_replace_all()</span></a>
<a class="sourceLine" id="cb47-3" title="3">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-4" title="4"><span class="st">    </span><span class="kw">transmute</span>(</a>
<a class="sourceLine" id="cb47-5" title="5">        customer_id,</a>
<a class="sourceLine" id="cb47-6" title="6">        <span class="dt">date =</span> birth_day <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-7" title="7"><span class="st">            </span><span class="kw">as.character</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-8" title="8"><span class="st">            </span><span class="kw">str_replace_all</span>(<span class="dt">pattern =</span> <span class="st">&quot;-&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb47-9" title="9">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb47-10" title="10"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    date    
##   &lt;chr&gt;          &lt;chr&gt;   
## 1 CS021313000114 19810429
## 2 CS037613000071 19520401
## 3 CS031415000172 19761004
## 4 CS028811000001 19330327
## 5 CS001215000145 19950329
## 6 CS020401000016 19740915</code></pre>
</div>
<div id="r-046" class="section level2 unnumbered hasAnchor">
<h2>R-046<a href="#r-046" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）の申し込み日（application_date）はYYYYMMDD形式の文字列型でデータを保有している。これを日付型に変換し、顧客ID（customer_id）とともに10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb49-1" title="1">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb49-2" title="2"><span class="st">    </span><span class="kw">transmute</span>(customer_id, <span class="dt">application_date =</span> <span class="kw">as.Date</span>(application_date)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb49-3" title="3"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    application_date
##   &lt;chr&gt;          &lt;date&gt;          
## 1 CS021313000114 2015-09-05      
## 2 CS037613000071 2015-04-14      
## 3 CS031415000172 2015-05-29      
## 4 CS028811000001 2016-01-15      
## 5 CS001215000145 2017-06-05      
## 6 CS020401000016 2015-02-25</code></pre>
</div>
<div id="r-047" class="section level2 unnumbered hasAnchor">
<h2>R-047<a href="#r-047" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上日（sales_ymd）はYYYYMMDD形式の数値型でデータを保有している。これを日付型に変換し、レシート番号(receipt_no)、レシートサブ番号（receipt_sub_no）とともに10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-2" title="2"><span class="st">    </span><span class="kw">transmute</span>(</a>
<a class="sourceLine" id="cb51-3" title="3">        <span class="dt">sales_date =</span> sales_ymd <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.character</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.Date</span>(),</a>
<a class="sourceLine" id="cb51-4" title="4">        receipt_no, receipt_sub_no</a>
<a class="sourceLine" id="cb51-5" title="5">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-6" title="6"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   sales_date receipt_no receipt_sub_no
##   &lt;date&gt;          &lt;int&gt;          &lt;int&gt;
## 1 2018-11-03        112              1
## 2 2018-11-18       1132              2
## 3 2017-07-12       1102              1
## 4 2019-02-05       1132              1
## 5 2018-08-21       1102              2
## 6 2019-06-05       1112              1</code></pre>
</div>
<div id="日付処理へのコメント" class="section level2 hasAnchor">
<h2><span class="header-section-number">3.1</span> 日付処理へのコメント<a href="#日付処理へのコメント" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>日付処理は SQL で書いた方が遥かに楽なので, R にこだわる必要なし.
R で日付を扱うパッケージとしては lubridate などがあるが, dbplyr 越しには使えないのでここでは書かない.
というわけで R-048 から R-051 はスキップ.</p>
</div>
<div id="r-052" class="section level2 unnumbered hasAnchor">
<h2>R-052<a href="#r-052" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上金額（amount）を顧客ID（customer_id）ごとに合計の上、売上金額合計に対して2,000円以下を0、2,000円より大きい金額を1に二値化し、顧客ID、売上金額合計とともに10件表示せよ。ただし、顧客IDが“Z”から始まるのものは非会員を表すため、除外して計算すること。</p>
</blockquote>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb53-2" title="2"><span class="co"># use stringr::str_detect()</span></a>
<a class="sourceLine" id="cb53-3" title="3">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-4" title="4"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-5" title="5"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-6" title="6"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-7" title="7"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">amount_over_2000 =</span> <span class="kw">if_else</span>(amount <span class="op">&gt;</span><span class="st"> </span><span class="dv">2000</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb53-8" title="8"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    amount amount_over_2000
##   &lt;chr&gt;           &lt;dbl&gt;            &lt;dbl&gt;
## 1 CS001311000059   2302                1
## 2 CS004614000122    248                0
## 3 CS003512000043    298                0
## 4 CS011615000061    246                0
## 5 CS029212000033   3604                1
## 6 CS007515000119   7157                1</code></pre>
</div>
<div id="r-053" class="section level2 unnumbered hasAnchor">
<h2>R-053<a href="#r-053" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）の郵便番号（postal_cd）に対し、東京（先頭3桁が100〜209のもの）を1、それ以外のものを0に二値化せよ。さらにレシート明細データ（df_receipt）と結合し、全期間において売上実績のある顧客数を、作成した二値ごとにカウントせよ。</p>
</blockquote>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" title="1">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb55-3" title="3">        <span class="dt">is_tokyo =</span> dplyr<span class="op">::</span><span class="kw">between</span>(<span class="kw">substr</span>(postal_cd, <span class="dv">1</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>(), <span class="dv">100</span>, <span class="dv">209</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-4" title="4"><span class="st">            </span><span class="kw">if_else</span>(<span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb55-5" title="5">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-6" title="6"><span class="st">    </span><span class="kw">inner_join</span>(receipt_tbl, <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-7" title="7"><span class="st">    </span><span class="kw">group_by</span>(is_tokyo) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-8" title="8"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">n_distinct</span>(customer_id)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb55-9" title="9"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 2]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   is_tokyo amount
##      &lt;dbl&gt;  &lt;dbl&gt;
## 1        0   3906
## 2        1   4400</code></pre>
</div>
<div id="r-054" class="section level2 unnumbered hasAnchor">
<h2>R-054<a href="#r-054" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）の住所（address）は、埼玉県、千葉県、東京都、神奈川県のいずれかとなっている。都道府県毎にコード値を作成し、顧客ID、住所とともに10件表示せよ。値は埼玉県を11、千葉県を12、東京都を13、神奈川県を14とすること。</p>
</blockquote>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" title="1">pref_vec &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;埼玉県&quot;</span>, <span class="st">&quot;千葉県&quot;</span>, <span class="st">&quot;東京都&quot;</span>, <span class="st">&quot;神奈川&quot;</span>)</a>
<a class="sourceLine" id="cb57-2" title="2">pref_map &lt;-<span class="st"> </span><span class="cf">function</span>(str) <span class="kw">which</span>(str <span class="op">==</span><span class="st"> </span>pref_vec) <span class="op">+</span><span class="st"> </span><span class="dv">10</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>()</a>
<a class="sourceLine" id="cb57-3" title="3"></a>
<a class="sourceLine" id="cb57-4" title="4">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-5" title="5"><span class="st">    </span><span class="kw">select</span>(customer_id, address) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-6" title="6"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-7" title="7"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb57-8" title="8">        <span class="kw">across</span>(</a>
<a class="sourceLine" id="cb57-9" title="9">            <span class="dt">.cols =</span> address,</a>
<a class="sourceLine" id="cb57-10" title="10">            <span class="dt">.fns =</span> <span class="cf">function</span>(cls) purrr<span class="op">::</span><span class="kw">map_int</span>(cls, <span class="op">~</span><span class="st"> </span><span class="kw">substr</span>(.x, <span class="dv">1</span>, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pref_map</span>()),</a>
<a class="sourceLine" id="cb57-11" title="11">            <span class="dt">.names =</span> <span class="st">&quot;pref_code&quot;</span></a>
<a class="sourceLine" id="cb57-12" title="12">        )</a>
<a class="sourceLine" id="cb57-13" title="13">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-14" title="14"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   customer_id    address                            pref_code
##   &lt;chr&gt;          &lt;chr&gt;                                  &lt;int&gt;
## 1 CS021313000114 神奈川県伊勢原市粟窪**********            14
## 2 CS037613000071 東京都江東区南砂**********                13
## 3 CS031415000172 東京都渋谷区代々木**********              13
## 4 CS028811000001 神奈川県横浜市泉区和泉町**********        14
## 5 CS001215000145 東京都大田区仲六郷**********              13
## 6 CS020401000016 東京都板橋区若木**********                13</code></pre>
</div>
<div id="r-055" class="section level2 unnumbered hasAnchor">
<h2>R-055<a href="#r-055" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細（df_receipt）データの売上金額（amount）を顧客ID（customer_id）ごとに合計し、その合計金額の四分位点を求めよ。その上で、顧客ごとの売上金額合計に対して以下の基準でカテゴリ値を作成し、顧客ID、売上金額合計とともに10件表示せよ。カテゴリ値は順に1〜4とする。</p>
<ul>
<li>最小値以上第1四分位未満: 1を付与</li>
<li>第1四分位以上第2四分位未満: 2を付与</li>
<li>第2四分位以上第3四分位未満: 3を付与</li>
<li>第3四分位以上: 4を付与</li>
</ul>
</blockquote>
<p>公式回答のように <code>case_when</code> で場合分けするのが素直なやり方だが, カテゴリ数が増えたとき非常に冗長なコードとなる. <code>collect()</code>を使ってもよいなら, つまり, <code>group_by(customer_id)</code> によってデータが十分に小さくなっているなら, 以下のような書き方もできる.
なぜ <code>collect()</code> が必要かと言うと, dbplyr が対応する SQL コードを生成する際に, <code>quantile</code> 関数の <code>probs</code> 引数の次元が2以上の場合を処理できないから.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-2" title="2"><span class="st">   </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-3" title="3"><span class="st">   </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-4" title="4"><span class="st">   </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-5" title="5"><span class="st">   </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb59-6" title="6">       <span class="kw">across</span>(</a>
<a class="sourceLine" id="cb59-7" title="7">           <span class="dt">.cols =</span> amount,</a>
<a class="sourceLine" id="cb59-8" title="8">           <span class="dt">.fns =</span> <span class="cf">function</span>(cls) {</a>
<a class="sourceLine" id="cb59-9" title="9">               q &lt;-<span class="st"> </span><span class="kw">quantile</span>(cls, <span class="dt">probs =</span> <span class="kw">c</span>(<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1.0</span>))</a>
<a class="sourceLine" id="cb59-10" title="10">               purrr<span class="op">::</span><span class="kw">map_int</span>(cls, <span class="op">~</span><span class="st"> </span><span class="kw">which</span>(.x <span class="op">&lt;=</span><span class="st"> </span>q) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">min</span>())</a>
<a class="sourceLine" id="cb59-11" title="11">           },</a>
<a class="sourceLine" id="cb59-12" title="12">           <span class="dt">.names =</span> <span class="st">&quot;pct_group&quot;</span></a>
<a class="sourceLine" id="cb59-13" title="13">       )</a>
<a class="sourceLine" id="cb59-14" title="14">   ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb59-15" title="15"><span class="st">   </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   customer_id    amount pct_group
##   &lt;chr&gt;           &lt;dbl&gt;     &lt;int&gt;
## 1 CS001311000059   2302         3
## 2 CS004614000122    248         1
## 3 CS003512000043    298         1
## 4 CS011615000061    246         1
## 5 CS029212000033   3604         3
## 6 CS007515000119   7157         4</code></pre>
</div>
<div id="r-056" class="section level2 unnumbered hasAnchor">
<h2>R-056<a href="#r-056" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）の年齢（age）をもとに10歳刻みで年代を算出し、顧客ID（customer_id）、生年月日（birth_day）とともに10件表示せよ。ただし、60歳以上は全て60歳代とすること。年代を表すカテゴリ名は任意とする。</p>
</blockquote>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">generation =</span> <span class="kw">if_else</span>(age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">60</span>, <span class="dv">60</span>, age <span class="op">-</span><span class="st"> </span>age <span class="op">%%</span><span class="st"> </span><span class="dv">10</span>)) -&gt;<span class="st"> </span>customer_generation</a>
<a class="sourceLine" id="cb61-3" title="3"></a>
<a class="sourceLine" id="cb61-4" title="4">customer_generation <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-5" title="5"><span class="st">    </span><span class="kw">select</span>(customer_id, birth_day, generation) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-6" title="6"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    birth_day  generation
##   &lt;chr&gt;          &lt;date&gt;          &lt;dbl&gt;
## 1 CS021313000114 1981-04-29         30
## 2 CS037613000071 1952-04-01         60
## 3 CS031415000172 1976-10-04         40
## 4 CS028811000001 1933-03-27         60
## 5 CS001215000145 1995-03-29         20
## 6 CS020401000016 1974-09-15         40</code></pre>
</div>
<div id="r-057" class="section level2 unnumbered hasAnchor">
<h2>R-057<a href="#r-057" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>056の抽出結果と性別コード（gender_cd）により、新たに性別×年代の組み合わせを表すカテゴリデータを作成し、10件表示せよ。組み合わせを表すカテゴリの値は任意とする。</p>
</blockquote>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" title="1">customer_generation <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-2" title="2"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">gender_generation =</span> gender_cd <span class="op">+</span><span class="st"> </span>generation) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-3" title="3"><span class="st">    </span><span class="kw">select</span>(</a>
<a class="sourceLine" id="cb63-4" title="4">        customer_id,</a>
<a class="sourceLine" id="cb63-5" title="5">        gender_cd,</a>
<a class="sourceLine" id="cb63-6" title="6">        gender,</a>
<a class="sourceLine" id="cb63-7" title="7">        age,</a>
<a class="sourceLine" id="cb63-8" title="8">        generation,</a>
<a class="sourceLine" id="cb63-9" title="9">        gender_generation</a>
<a class="sourceLine" id="cb63-10" title="10">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-11" title="11"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 6]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    gender_cd gender   age generation gender_generation
##   &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;  &lt;int&gt;      &lt;dbl&gt;             &lt;dbl&gt;
## 1 CS021313000114         1 女性      37         30                31
## 2 CS037613000071         9 不明      66         60                69
## 3 CS031415000172         1 女性      42         40                41
## 4 CS028811000001         1 女性      86         60                61
## 5 CS001215000145         1 女性      24         20                21
## 6 CS020401000016         0 男性      44         40                40</code></pre>
</div>
<div id="r-058" class="section level2 unnumbered hasAnchor">
<h2>R-058<a href="#r-058" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>顧客データ（df_customer）の性別コード（gender_cd）をダミー変数化し、顧客ID（customer_id）とともに10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-2" title="2"><span class="st">    </span><span class="kw">select</span>(customer_id, gender_cd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-3" title="3"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-4" title="4"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw">pivot_wider</span>(</a>
<a class="sourceLine" id="cb65-5" title="5">        <span class="dt">names_from =</span> gender_cd,</a>
<a class="sourceLine" id="cb65-6" title="6">        <span class="dt">names_prefix =</span> <span class="st">&quot;gender_cd&quot;</span>,</a>
<a class="sourceLine" id="cb65-7" title="7">        <span class="dt">values_from =</span> value,</a>
<a class="sourceLine" id="cb65-8" title="8">        <span class="dt">values_fill =</span> <span class="dv">0</span></a>
<a class="sourceLine" id="cb65-9" title="9">    )</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 4]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##    customer_id    gender_cd0 gender_cd9 gender_cd1
##    &lt;chr&gt;               &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
##  1 CS001105000001          1          0          0
##  2 CS001112000009          0          0          1
##  3 CS001112000019          0          0          1
##  4 CS001112000021          0          0          1
##  5 CS001112000023          0          0          1
##  6 CS001112000024          0          0          1
##  7 CS001112000029          0          0          1
##  8 CS001112000030          0          0          1
##  9 CS001113000004          0          0          1
## 10 CS001113000010          0          0          1
## # … with more rows</code></pre>
</div>
<div id="r-059" class="section level2 unnumbered hasAnchor">
<h2>R-059<a href="#r-059" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上金額（amount）を顧客ID（customer_id）ごとに合計し、売上金額合計を平均0、標準偏差1に標準化して顧客ID、売上金額合計とともに10件表示せよ。標準化に使用する標準偏差は、分散の平方根、もしくは不偏分散の平方根のどちらでも良いものとする。ただし、顧客IDが“Z”から始まるのものは非会員を表すため、除外して計算すること。</p>
</blockquote>
<p>scale 関数を dbplyr 越しに使えないので, <code>mean</code> と <code>sd</code> を使ってベタ書きする.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb67-2" title="2"><span class="co"># stringr::str_detect()</span></a>
<a class="sourceLine" id="cb67-3" title="3">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-4" title="4"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-5" title="5"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-6" title="6"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-7" title="7"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">std_amount =</span> (amount <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(amount)) <span class="op">/</span><span class="st"> </span><span class="kw">sd</span>(amount)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb67-8" title="8"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   customer_id    amount std_amount
##   &lt;chr&gt;           &lt;dbl&gt;      &lt;dbl&gt;
## 1 CS001311000059   2302    -0.0903
## 2 CS004614000122    248    -0.845 
## 3 CS003512000043    298    -0.827 
## 4 CS011615000061    246    -0.846 
## 5 CS029212000033   3604     0.388 
## 6 CS007515000119   7157     1.69</code></pre>
<p><code>collect()</code> していいなら, <code>scale</code> 関数を使って公式回答のように書ける.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb69-2" title="2"><span class="co"># stringr::str_detect()</span></a>
<a class="sourceLine" id="cb69-3" title="3">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-4" title="4"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-5" title="5"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-6" title="6"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-7" title="7"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-8" title="8"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">std_amount =</span> <span class="kw">scale</span>(amount, <span class="dt">center =</span> <span class="ot">TRUE</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-9" title="9"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   customer_id    amount std_amount[,1]
##   &lt;chr&gt;           &lt;dbl&gt;          &lt;dbl&gt;
## 1 CS001311000059   2302        -0.0903
## 2 CS004614000122    248        -0.845 
## 3 CS003512000043    298        -0.827 
## 4 CS011615000061    246        -0.846 
## 5 CS029212000033   3604         0.388 
## 6 CS007515000119   7157         1.69</code></pre>
</div>
<div id="r-060" class="section level2 unnumbered hasAnchor">
<h2>R-060<a href="#r-060" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上金額（amount）を顧客ID（customer_id）ごとに合計し、売上金額合計を最小値0、最大値1に正規化して顧客ID、売上金額合計とともに10件表示せよ。ただし、顧客IDが“Z”から始まるのものは非会員を表すため、除外して計算すること。</p>
</blockquote>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" title="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb71-2" title="2"><span class="co"># stringr::str_detect()</span></a>
<a class="sourceLine" id="cb71-3" title="3">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-4" title="4"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-5" title="5"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-6" title="6"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-7" title="7"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">relative_pos =</span> <span class="kw">as.numeric</span>((amount <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(amount))) <span class="op">/</span><span class="st"> </span>(<span class="kw">max</span>(amount) <span class="op">-</span><span class="st"> </span><span class="kw">min</span>(amount))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb71-8" title="8"><span class="st">    </span><span class="kw">head</span>(<span class="dv">10</span>)</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 3]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##    customer_id    amount relative_pos
##    &lt;chr&gt;           &lt;dbl&gt;        &lt;dbl&gt;
##  1 CS001311000059   2302      0.0970 
##  2 CS004614000122    248      0.00773
##  3 CS003512000043    298      0.00991
##  4 CS011615000061    246      0.00765
##  5 CS029212000033   3604      0.154  
##  6 CS007515000119   7157      0.308  
##  7 CS034515000123   3699      0.158  
##  8 CS004315000058    490      0.0182 
##  9 CS026414000014   6671      0.287  
## 10 CS001615000099    768      0.0303</code></pre>

</div>
<div id="r-069" class="section level2 unnumbered hasAnchor">
<h2>R-069<a href="#r-069" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）と商品データ（df_product）を結合し、顧客毎に全商品の売上金額合計と、カテゴリ大区分コード（category_major_cd）が“07”（瓶詰缶詰）の売上金額合計を計算の上、両者の比率を求めよ。抽出対象はカテゴリ大区分コード“07”（瓶詰缶詰）の売上実績がある顧客のみとし、結果を10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-2" title="2"><span class="st">    </span><span class="kw">inner_join</span>(product_tbl, <span class="dt">by =</span> <span class="st">&quot;product_cd&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-3" title="3"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-4" title="4"><span class="st">    </span><span class="kw">summarise</span>(</a>
<a class="sourceLine" id="cb73-5" title="5">        <span class="dt">amount_canned =</span> <span class="kw">sum</span>(<span class="kw">if_else</span>(category_major_cd <span class="op">==</span><span class="st"> &quot;07&quot;</span>, amount, <span class="dv">0</span>), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb73-6" title="6">        <span class="dt">amount_total =</span> <span class="kw">sum</span>(amount)</a>
<a class="sourceLine" id="cb73-7" title="7">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-8" title="8"><span class="st">    </span><span class="kw">filter</span>(amount_canned <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-9" title="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">canned_ratio =</span> <span class="kw">as.numeric</span>(amount_canned) <span class="op">/</span><span class="st"> </span>amount_total) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-10" title="10"><span class="st">    </span><span class="kw">head</span>(<span class="dv">10</span>)</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 4]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##    customer_id    amount_canned amount_total canned_ratio
##    &lt;chr&gt;                  &lt;dbl&gt;        &lt;dbl&gt;        &lt;dbl&gt;
##  1 CS001113000004          1298         1298        1    
##  2 CS001114000005           486          626        0.776
##  3 CS001115000010          2694         3044        0.885
##  4 CS001205000004           346         1988        0.174
##  5 CS001205000006          2004         3337        0.601
##  6 CS001212000027           200          448        0.446
##  7 CS001212000031           296          296        1    
##  8 CS001212000046           108          228        0.474
##  9 CS001212000070           308          456        0.675
## 10 CS001213000018           145          243        0.597</code></pre>
</div>
<div id="r-070" class="section level2 unnumbered hasAnchor">
<h2>R-070<a href="#r-070" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上日（sales_ymd）に対し、顧客データ（df_customer）の会員申込日（application_date）からの経過日数を計算し、顧客ID（customer_id）、売上日、会員申込日とともに10件表示せよ（sales_ymdは数値、application_dateは文字列でデータを保持している点に注意）。</p>
</blockquote>
<p><code>collect()</code> しないなら日付周りは SQL でやった方がマシだと思うので, ここでは <code>collect()</code> する前提で lubridate パッケージを使う.</p>
<p><code>lubridate::ymd()</code> で文字列や数値を日付型に変換し, 差分時間を <code>lubridate::interval</code> に流して, <code>%/% days(1)</code> などで希望単位での (端数切捨ての) 経過時間を得る. <code>%/% days(1)</code> の部分を <code>%/% months(1)</code> や <code>%/% years(1)</code> や <code>%/% seconds(1)</code> とするだけで類似問題を処理できる.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" title="1">customer_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-2" title="2"><span class="st">    </span><span class="kw">inner_join</span>(receipt_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(customer_id, sales_ymd), <span class="dt">by =</span> <span class="st">&quot;customer_id&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-3" title="3"><span class="st">    </span><span class="kw">select</span>(customer_id, sales_ymd, application_date) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-4" title="4"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-5" title="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">elapsed_days =</span> lubridate<span class="op">::</span><span class="kw">interval</span>(lubridate<span class="op">::</span><span class="kw">ymd</span>(application_date), lubridate<span class="op">::</span><span class="kw">ymd</span>(sales_ymd)) <span class="op">%/%</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">days</span>(<span class="dv">1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb75-6" title="6"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   customer_id    sales_ymd application_date elapsed_days
##   &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;                   &lt;dbl&gt;
## 1 CS006214000001  20181103 20150201                 1371
## 2 CS008415000097  20181118 20150322                 1337
## 3 CS028414000014  20170712 20150711                  732
## 4 CS025415000050  20180821 20160131                  933
## 5 CS003515000195  20190605 20150306                 1552
## 6 CS024514000042  20181205 20151010                 1152</code></pre>
</div>
<div id="r-074" class="section level2 unnumbered hasAnchor">
<h2>R-074<a href="#r-074" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上日（sales_ymd）に対し、当該週の月曜日からの経過日数を計算し、売上日、直前の月曜日付とともに10件表示せよ（sales_ymdは数値でデータを保持している点に注意）。</p>
</blockquote>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-2" title="2"><span class="st">    </span><span class="kw">select</span>(sales_ymd) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-3" title="3"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-4" title="4"><span class="st">    </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb77-5" title="5">        <span class="dt">elapsed_weekdays =</span> lubridate<span class="op">::</span><span class="kw">ymd</span>(sales_ymd) <span class="op">%&gt;%</span><span class="st"> </span>lubridate<span class="op">::</span><span class="kw">wday</span>(<span class="dt">week_start =</span> <span class="dv">1</span>) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb77-6" title="6">        <span class="dt">last_monday =</span> lubridate<span class="op">::</span><span class="kw">ymd</span>(sales_ymd) <span class="op">-</span><span class="st"> </span>elapsed_weekdays</a>
<a class="sourceLine" id="cb77-7" title="7">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-8" title="8"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 3
##   sales_ymd elapsed_weekdays last_monday
##       &lt;int&gt;            &lt;dbl&gt; &lt;date&gt;     
## 1  20181103                5 2018-10-29 
## 2  20181118                6 2018-11-12 
## 3  20170712                2 2017-07-10 
## 4  20190205                1 2019-02-04 
## 5  20180821                1 2018-08-20 
## 6  20190605                2 2019-06-03</code></pre>
</div>
<div id="r-078" class="section level2 unnumbered hasAnchor">
<h2>R-078<a href="#r-078" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>レシート明細データ（df_receipt）の売上金額（amount）を顧客単位に合計し、合計した売上金額の外れ値を抽出せよ。ただし、顧客IDが“Z”から始まるのものは非会員を表すため、除外して計算すること。なお、ここでは外れ値を第1四分位と第3四分位の差であるIQRを用いて、「第1四分位数-1.5×IQR」を下回るもの、または「第3四分位数+1.5×IQR」を超えるものとする。結果は10件表示せよ。</p>
</blockquote>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" title="1">receipt_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-2" title="2"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">str_detect</span>(customer_id, <span class="st">&quot;^Z&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-3" title="3"><span class="st">    </span><span class="kw">group_by</span>(customer_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-4" title="4"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">amount =</span> <span class="kw">sum</span>(amount, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-5" title="5"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-6" title="6"><span class="st">    </span><span class="kw">filter</span>(</a>
<a class="sourceLine" id="cb79-7" title="7">        amount <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-8" title="8"><span class="st">            </span>{</a>
<a class="sourceLine" id="cb79-9" title="9">                . <span class="op">&gt;</span><span class="st"> </span><span class="kw">quantile</span>(., <span class="dt">probs =</span> <span class="fl">0.25</span>) <span class="op">+</span><span class="st"> </span><span class="fl">1.5</span> <span class="op">*</span><span class="st"> </span><span class="kw">IQR</span>(.) <span class="op">|</span><span class="st"> </span>. <span class="op">&lt;</span><span class="st"> </span><span class="kw">quantile</span>(., <span class="dt">probs =</span> <span class="fl">0.25</span>) <span class="op">-</span><span class="st"> </span><span class="fl">1.5</span> <span class="op">*</span><span class="st"> </span><span class="kw">IQR</span>(.)</a>
<a class="sourceLine" id="cb79-10" title="10">            }</a>
<a class="sourceLine" id="cb79-11" title="11">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb79-12" title="12"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 2
##   customer_id    amount
##   &lt;chr&gt;           &lt;dbl&gt;
## 1 CS007515000119   7157
## 2 CS026414000014   6671
## 3 CS016414000063   6207
## 4 CS039814000011   8031
## 5 CS013415000226   8362
## 6 CS009415000117   8229</code></pre>
</div>
<div id="r-079" class="section level2 unnumbered hasAnchor">
<h2>R-079<a href="#r-079" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>商品データ（df_product）の各項目に対し、欠損数を確認せよ。</p>
</blockquote>
<p>やりたいことは最終行だが, そのためにはデータをダウンロードする必要があるので, その前に <code>NA</code> を含む行だけに絞り込んでデータサイズを落とす処理を入れた.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" title="1">product_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-2" title="2"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">if_any</span>(<span class="op">-</span><span class="kw">c</span>(), <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-3" title="3"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb81-4" title="4"><span class="st">    </span><span class="kw">summarise</span>(<span class="kw">across</span>(<span class="kw">everything</span>(), <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sum</span>()))</a></code></pre></div>
<pre><code>## # A tibble: 1 × 6
##   product_cd category_major_cd category_medium_cd category_small_cd unit_price
##        &lt;int&gt;             &lt;int&gt;              &lt;int&gt;             &lt;int&gt;      &lt;int&gt;
## 1          0                 0                  0                 0          7
## # … with 1 more variable: unit_cost &lt;int&gt;</code></pre>
</div>
<div id="r-080" class="section level2 unnumbered hasAnchor">
<h2>R-080<a href="#r-080" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p>商品データ（df_product）のいずれかの項目に欠損が発生しているレコードを全て削除した新たな商品データを作成せよ。なお、削除前後の件数を表示させ、079で確認した件数だけ減少していることも確認すること。</p>
</blockquote>
<p>R079 の絞り込み処理を反転させるだけ.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" title="1">product_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-2" title="2"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">if_all</span>(<span class="op">-</span><span class="kw">c</span>(), <span class="op">~</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb83-3" title="3"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # Source:   lazy query [?? x 6]
## # Database: postgres 12.0.11 [@localhost:5432/knock100]
##   product_cd category_major_cd category_medium_cd category_small_cd unit_price
##   &lt;chr&gt;      &lt;chr&gt;             &lt;chr&gt;              &lt;chr&gt;                  &lt;int&gt;
## 1 P040101001 04                0401               040101                   198
## 2 P040101002 04                0401               040101                   218
## 3 P040101003 04                0401               040101                   230
## 4 P040101004 04                0401               040101                   248
## 5 P040101005 04                0401               040101                   268
## 6 P040101006 04                0401               040101                   298
## # … with 1 more variable: unit_cost &lt;int&gt;</code></pre>
<p>データを手元にダウンロードしていいなら <code>complete.cases</code>が手軽.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" title="1">product_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-2" title="2"><span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-3" title="3"><span class="st">    </span><span class="kw">filter</span>(<span class="kw">complete.cases</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb85-4" title="4"><span class="st">    </span><span class="kw">head</span>()</a></code></pre></div>
<pre><code>## # A tibble: 6 × 6
##   product_cd category_major_cd category_medium_cd category_small_cd unit_price
##   &lt;chr&gt;      &lt;chr&gt;             &lt;chr&gt;              &lt;chr&gt;                  &lt;int&gt;
## 1 P040101001 04                0401               040101                   198
## 2 P040101002 04                0401               040101                   218
## 3 P040101003 04                0401               040101                   230
## 4 P040101004 04                0401               040101                   248
## 5 P040101005 04                0401               040101                   268
## 6 P040101006 04                0401               040101                   298
## # … with 1 more variable: unit_cost &lt;int&gt;</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "night",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

</body>

</html>
